<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.pm.dao.ProjectDao">

    <resultMap id="project" type="com.pm.entity.project.CoreProject">
        <id property="projectId" column="pm_project_id" />
        <result property="projectName" column="pm_project_name" />
        <result property="projectIcon" column="pm_project_icon" />
        <result property="projectArea" column="pm_project_area" />
        <result property="projectCustomer" column="pm_project_customer" />
        <result property="startDate" column="pm_project_start_date" />
        <result property="endDate" column="pm_project_end_date" />
        <result property="createdById" column="pm_created_by_id" />
        <result property="createdDate" column="pm_created_date" />
        <result property="describe" column="pm_describe" />
        <result property="delFlag" column="pm_del_flag" />
        <association property="createdBy" javaType="com.pm.entity.user.CoreUser">
            <id property="id" column="pm_userId"/>
            <result column="pm_userUsername" property="username"/>
            <result column="pm_userRealName" property="realName"/>
            <result column="pm_userHeadPortrait" property="headPortrait"/>
            <result column="pm_userNickname" property="nickname"/>
            <result column="pm_userAuthority" property="authority"/>
            <result column="pm_is_manager" property="isManager"/>
            <result column="pm_is_leader" property="isLeader"/>
        </association>
        <collection property="projectManager" ofType="com.pm.entity.user.CoreUser">
            <id property="id" column="pm_userId"/>
            <result column="pm_userUsername" property="username"/>
            <result column="pm_userRealName" property="realName"/>
            <result column="pm_userHeadPortrait" property="headPortrait"/>
            <result column="pm_userNickname" property="nickname"/>
            <result column="pm_userAuthority" property="authority"/>
            <result column="pm_is_manager" property="isManager"/>
            <result column="pm_is_leader" property="isLeader"/>
        </collection>
        <collection property="projectMember" ofType="com.pm.entity.user.CoreUser">
            <id property="id" column="pm_userId"/>
            <result column="pm_userUsername" property="username"/>
            <result column="pm_userRealName" property="realName"/>
            <result column="pm_userHeadPortrait" property="headPortrait"/>
            <result column="pm_userNickname" property="nickname"/>
            <result column="pm_userAuthority" property="authority"/>
            <result column="pm_is_manager" property="isManager"/>
            <result column="pm_is_leader" property="isLeader"/>
        </collection>
    </resultMap>

    <!--  项目查询字段  -->
    <sql id="project">
        pm_project.project_id as pm_project_id,
        pm_project.project_name as pm_project_name,
        pm_project.project_icon as pm_project_icon,
        pm_project.project_area as pm_project_area,
        pm_project.project_customer as pm_project_customer,
        pm_project.start_date as pm_project_start_date,
        pm_project.end_date as pm_project_end_date,
        pm_project.created_by_id as pm_created_by_id,
        pm_project.created_date as pm_created_date,
        pm_project.describe as pm_describe,
        pm_project.del_flag as pm_del_flag
    </sql>

    <!-- 用户查询字段 -->
    <sql id="user">
        pm_user.id as pm_userId,
        pm_user.username as pm_userUsername,
        pm_user.real_name as pm_userRealName,
        pm_user.head_portrait as pm_userHeadPortrait,
        pm_user.nickname as pm_userNickname,
        pm_user.authority as pm_userAuthority
    </sql>

    <!--  根据项目名查询项目的详细信息  -->
    <select id="queryProjectByProjectName" resultMap="project">
        SELECT
        <include refid="project" />,
        r.pm_userId,
        r.pm_userUsername,
        r.pm_userRealName,
        r.pm_userHeadPortrait,
        r.pm_userNickname,
        r.pm_userAuthority,
        r.pm_is_manager,
        r.pm_is_leader
        FROM
        (
            SELECT
            pu.project_id,
            u.id as pm_userId,
            u.username as pm_userUsername,
            u.real_name as pm_userRealName,
            u.head_portrait as pm_userHeadPortrait,
            u.nickname as pm_userNickname,
            u.authority as pm_userAuthority,
            u.is_manager as pm_is_manager,
            u.is_leader as pm_is_leader
            FROM pm_project_user pu RIGHT JOIN pm_user u ON pu.user_id = u.id
        ) r
        LEFT JOIN pm_project ON pm_project.project_id = r.project_id
        WHERE pm_project.project_name = #{projectName}
        AND pm_project.del_flag = 1
    </select>

    <insert id="createProject" useGeneratedKeys="true" keyProperty="projectId">
        INSERT INTO pm_project(project_name, project_icon, project_area, project_customer, start_date, end_date, created_by_id, created_date, `describe`)
        VALUES(#{projectDto.projectName}, #{projectDto.projectIcon}, #{projectDto.projectArea}, #{projectDto.projectCustomer},
               #{projectDto.startDate}, #{projectDto.endDate}, #{projectDto.createdById}, #{projectDto.createdDate}, #{projectDto.describe})
    </insert>

    <!--  修改项目标识(0:删除,1:正常)  -->
    <update id="updateProjectFlag">
        UPDATE pm_project SET pm_project.del_flag = #{delFlag}
        WHERE pm_project.project_id = #{projectId}
    </update>

</mapper>